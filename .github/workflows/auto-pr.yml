name: Auto Create Pull Request

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check-pr
        run: |
          # í˜„ì¬ ë¸Œëœì¹˜ì— ëŒ€í•œ PRì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq 'length')
          echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Read PR description if exists
        id: pr-description
        run: |
          BRANCH_NAME="${{ steps.check-pr.outputs.branch_name }}"

          # PR_DESCRIPTION.md íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -f "projects/tower-stacker/PR_DESCRIPTION.md" ]; then
            echo "Using PR_DESCRIPTION.md"
            BODY_FILE="projects/tower-stacker/PR_DESCRIPTION.md"
          else
            # ê¸°ë³¸ í…œí”Œë¦¿
            echo "## ë³€ê²½ì‚¬í•­" > /tmp/pr-body.md
            echo "" >> /tmp/pr-body.md
            echo "ì´ PRì€ \`$BRANCH_NAME\` ë¸Œëœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì„ í¬í•¨í•©ë‹ˆë‹¤." >> /tmp/pr-body.md
            echo "" >> /tmp/pr-body.md
            echo "### ì»¤ë°‹ ë‚´ì—­" >> /tmp/pr-body.md
            git log --oneline main..$BRANCH_NAME >> /tmp/pr-body.md
            BODY_FILE="/tmp/pr-body.md"
          fi
          echo "body_file=$BODY_FILE" >> $GITHUB_OUTPUT

      - name: Extract PR title from last commit
        id: pr-title
        run: |
          # ë§ˆì§€ë§‰ ì»¤ë°‹ ë©”ì‹œì§€ì˜ ì²« ì¤„ì„ ì œëª©ìœ¼ë¡œ ì‚¬ìš©
          TITLE=$(git log -1 --pretty=format:%s)
          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == '0'
        run: |
          BRANCH_NAME="${{ steps.check-pr.outputs.branch_name }}"
          TITLE="${{ steps.pr-title.outputs.title }}"
          BODY_FILE="${{ steps.pr-description.outputs.body_file }}"

          gh pr create \
            --title "$TITLE" \
            --body-file "$BODY_FILE" \
            --base main \
            --head "$BRANCH_NAME"

          echo "âœ… PRì´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Comment on existing PR
        if: steps.check-pr.outputs.pr_exists != '0'
        run: |
          BRANCH_NAME="${{ steps.check-pr.outputs.branch_name }}"
          echo "â„¹ï¸ PRì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ìƒˆë¡œìš´ ì»¤ë°‹ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."

          # ê¸°ì¡´ PRì— ì½”ë©˜íŠ¸ ì¶”ê°€ (ì„ íƒì‚¬í•­)
          PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number')
          gh pr comment $PR_NUMBER --body "ğŸ”„ ìƒˆë¡œìš´ ì»¤ë°‹ì´ í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤: $(git log -1 --pretty=format:%s)"
        env:
          GH_TOKEN: ${{ github.token }}
