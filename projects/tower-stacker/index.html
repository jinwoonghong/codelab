<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4ECDC4">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- PWA Meta Tags -->
    <meta name="description" content="ë¸”ë¡ì„ ìŒ“ì•„ ìµœê³  ê¸°ë¡ì„ ë§Œë“œì„¸ìš”! 4ê°€ì§€ ê²Œìž„ ëª¨ë“œ, íŠ¹ìˆ˜ ë¸”ë¡, ìŠ¤í‚¨ ì‹œìŠ¤í…œì´ ìžˆëŠ” ì¤‘ë…ì„± ìžˆëŠ” í¼ì¦ ê²Œìž„">
    <meta name="keywords" content="íƒ€ì›Œ ìŠ¤íƒœì»¤, tower stacker, ë¸”ë¡ ìŒ“ê¸°, í¼ì¦ ê²Œìž„, ì›¹ ê²Œìž„, ëª¨ë°”ì¼ ê²Œìž„">
    <meta name="author" content="Tower Stacker Team">

    <!-- Open Graph -->
    <meta property="og:type" content="game">
    <meta property="og:title" content="íƒ€ì›Œ ìŠ¤íƒœì»¤ - Tower Stacker">
    <meta property="og:description" content="ë¸”ë¡ì„ ìŒ“ì•„ ìµœê³  ê¸°ë¡ì„ ë§Œë“œì„¸ìš”!">
    <meta property="og:url" content="https://tower-stacker.app">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-192x192.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <title>íƒ€ì›Œ ìŠ¤íƒœì»¤ - Tower Stacker</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div id="game-container">
        <!-- Phaser ê²Œìž„ ìº”ë²„ìŠ¤ê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
    </div>

    <!-- Phaser 3 ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>

    <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>

    <!-- ê²Œìž„ ì„¤ì • -->
    <script src="src/config.js"></script>

    <!-- ìœ í‹¸ë¦¬í‹° -->
    <script src="src/utils/DataManager.js"></script>

    <!-- ë§¤ë‹ˆì € -->
    <script src="src/managers/ScoreManager.js"></script>
    <script src="src/managers/ReplayManager.js"></script>
    <script src="src/managers/GifManager.js"></script>
    <script src="src/managers/SoundManager.js"></script>

    <!-- ì—”í‹°í‹° -->
    <script src="src/entities/Block.js"></script>
    <script src="src/entities/SpecialBlocks.js"></script>

    <!-- ì”¬ -->
    <script src="src/scenes/BootScene.js"></script>
    <script src="src/scenes/TutorialScene.js"></script>
    <script src="src/scenes/MainMenuScene.js"></script>
    <script src="src/scenes/GameScene.js"></script>
    <script src="src/scenes/GameOverScene.js"></script>
    <script src="src/scenes/ShopScene.js"></script>
    <script src="src/scenes/MuseumScene.js"></script>
    <script src="src/scenes/ChallengeScene.js"></script>
    <script src="src/scenes/SettingsScene.js"></script>

    <!-- ë©”ì¸ ê²Œìž„ íŒŒì¼ -->
    <script src="src/game.js"></script>

    <!-- PWA Service Worker ë“±ë¡ -->
    <script>
        // Service Worker ë“±ë¡
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('âœ… Service Worker registered:', registration.scope);

                        // ì—…ë°ì´íŠ¸ í™•ì¸
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // ìƒˆ ë²„ì „ ì‚¬ìš© ê°€ëŠ¥
                                    console.log('ðŸ†• New version available!');
                                    if (confirm('ìƒˆë¡œìš´ ë²„ì „ì´ ìžˆìŠµë‹ˆë‹¤. ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('âŒ Service Worker registration failed:', error);
                    });

                // Service Worker ì—…ë°ì´íŠ¸ ì‹œ íŽ˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (!refreshing) {
                        refreshing = true;
                        window.location.reload();
                    }
                });
            });
        }

        // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            // ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ë°©ì§€
            e.preventDefault();
            deferredPrompt = e;

            // ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ (ì„ íƒì )
            console.log('ðŸ’¾ PWA installation available');

            // 5ì´ˆ í›„ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ (í•œ ë²ˆë§Œ)
            const installPromptShown = localStorage.getItem('installPromptShown');
            if (!installPromptShown) {
                setTimeout(() => {
                    if (confirm('íƒ€ì›Œ ìŠ¤íƒœì»¤ë¥¼ í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì˜¤í”„ë¼ì¸ì—ì„œë„ í”Œë ˆì´í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤!')) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('âœ… User accepted PWA install');
                            } else {
                                console.log('âŒ User dismissed PWA install');
                            }
                            deferredPrompt = null;
                        });
                    }
                    localStorage.setItem('installPromptShown', 'true');
                }, 5000);
            }
        });

        // PWA ì„¤ì¹˜ ì™„ë£Œ
        window.addEventListener('appinstalled', () => {
            console.log('âœ… PWA installed successfully');
            deferredPrompt = null;
        });
    </script>
</body>
</html>
